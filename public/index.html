<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NAS 控制台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            /* 背景图由 JS 动态设置 */
            background-size: cover;
            background-position: center;
            background-attachment: fixed; /* 固定背景，滚动时不移动 */
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
            transition: background-image 0.5s ease-in-out; /* 背景切换动画 */
        }
        .backdrop-blur-md {
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }
        .bg-white\/10 {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .bg-white\/20 {
            background-color: rgba(255, 255, 255, 0.2);
        }
        .bg-white\/30 {
            background-color: rgba(255, 255, 255, 0.3);
        }
        .icon-item:hover {
            transform: scale(1.05);
            background-color: rgba(255, 255, 255, 0.25);
        }
        .icon-item {
            transition: all 0.2s ease-in-out;
        }
        .modal-body::-webkit-scrollbar, .side-panel-body::-webkit-scrollbar, #system-info-content::-webkit-scrollbar {
            display: none;
        }
        .modal-body, .side-panel-body, #system-info-content {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        h2, h3, .icon-item span, strong {
            color: #f8fafc; /* text-slate-50 */
        }
    </style>
</head>
<body class="text-slate-200">

    <main class="min-h-screen w-full flex items-center justify-center p-4 lg:p-6">
        <!-- 整体宽度加宽 -->
        <div class="w-full max-w-screen-2xl flex flex-col lg:flex-row items-stretch justify-center gap-6">
            <!-- 左侧边栏: 系统信息 -->
            <div id="system-info-container" class="backdrop-blur-md bg-white/10 p-4 rounded-xl shadow-lg w-full lg:w-80 flex-shrink-0 flex flex-col order-2 lg:order-1">
                <h3 class="font-bold text-lg text-center flex-shrink-0">设备信息</h3>
                <hr class="border-white/10 my-3">
                <div id="system-info-content" class="text-sm space-y-4 flex-grow overflow-y-auto side-panel-body">正在加载系统信息...</div>
            </div>

            <!-- 中间: 导航面板 -->
            <div class="backdrop-blur-md bg-white/10 p-4 sm:p-6 rounded-xl shadow-lg w-full lg:flex-grow order-1 lg:order-2">
                 <!-- 导航栏修改为每行5个图标 -->
                 <div id="nav-container" class="grid grid-cols-3 sm:grid-cols-4 lg:grid-cols-5 gap-4">
                    <div class="text-center p-4 rounded-lg col-span-full">正在加载导航...</div>
                </div>
            </div>

            <!-- 右侧边栏: 天气信息 -->
            <div id="weather-container" class="backdrop-blur-md bg-white/10 p-4 rounded-xl shadow-lg w-full lg:w-80 flex-shrink-0 flex flex-col order-3">
                <h3 class="font-bold text-lg text-center flex-shrink-0">天气信息</h3>
                <hr class="border-white/10 my-3">
                <div id="weather-content" class="space-y-4 text-sm overflow-y-auto side-panel-body">正在加载天气...</div>
            </div>
        </div>
    </main>

    <button id="settings-btn" class="fixed top-4 right-4 backdrop-blur-md bg-white/20 p-2 rounded-full hover:bg-white/30 transition-colors z-50">
        <i data-lucide="settings"></i>
    </button>

    <div id="settings-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-white/20 backdrop-blur-md rounded-2xl w-full max-w-4xl h-[80vh] flex flex-col shadow-2xl text-slate-100">
            <div class="p-4 border-b border-white/20 flex justify-between items-center">
                <h2 class="text-xl font-bold">设置</h2>
                <button id="close-modal-btn" class="p-1 rounded-full hover:bg-white/20"><i data-lucide="x"></i></button>
            </div>
            <div class="flex-grow p-4 overflow-y-auto modal-body">
                <!-- 导航项设置 -->
                <div>
                    <h3 class="font-semibold text-lg mb-2">导航项目</h3>
                    <div id="nav-settings-container" class="space-y-2"></div>
                    <button id="add-nav-item-btn" class="mt-2 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">添加导航项</button>
                </div>

                <!-- 天气城市设置 -->
                <div class="mt-6">
                    <h3 class="font-semibold text-lg mb-2">天气城市</h3>
                    <div id="weather-settings-container" class="space-y-2"></div>
                    <button id="add-weather-city-btn" class="mt-2 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">添加城市</button>
                </div>
                
                <!-- 背景设置 -->
                <div class="mt-6">
                    <h3 class="font-semibold text-lg mb-2">背景设置</h3>
                    <div id="background-settings-container" class="space-y-3">
                        <label class="flex items-center gap-2 p-2 bg-white/10 rounded-lg">
                            <input type="radio" name="bg-type" value="bing" class="form-radio h-4 w-4 text-blue-500 bg-transparent border-white/30">
                            <span>使用每日壁纸</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 bg-white/10 rounded-lg">
                            <input type="radio" name="bg-type" value="url" class="form-radio h-4 w-4 text-blue-500 bg-transparent border-white/30">
                            <span>使用自定义链接</span>
                        </label>
                        <div id="bg-url-input-container" class="hidden pl-8">
                            <input type="text" id="bg-url-input" placeholder="输入图片 URL" class="w-full bg-transparent border-b border-white/30 p-1 focus:outline-none focus:border-white placeholder:text-slate-400">
                        </div>
                        <label class="flex items-center gap-2 p-2 bg-white/10 rounded-lg">
                            <input type="radio" name="bg-type" value="upload" class="form-radio h-4 w-4 text-blue-500 bg-transparent border-white/30">
                            <span>上传自定义图片</span>
                        </label>
                         <div id="bg-upload-container" class="hidden pl-8">
                            <input type="file" id="bg-upload-input" class="hidden" accept="image/*">
                            <button id="bg-upload-btn" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-1 px-3 rounded-lg text-sm">选择文件</button>
                            <span id="bg-upload-path" class="ml-2 text-sm text-slate-300"></span>
                        </div>
                    </div>
                </div>

            </div>
            <div class="p-4 border-t border-white/20 text-right">
                <button id="save-settings-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">保存设置</button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const navContainer = document.getElementById('nav-container');
            const systemInfoContent = document.getElementById('system-info-content');
            const weatherContent = document.getElementById('weather-content');
            const settingsBtn = document.getElementById('settings-btn');
            const settingsModal = document.getElementById('settings-modal');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const saveSettingsBtn = document.getElementById('save-settings-btn');
            const navSettingsContainer = document.getElementById('nav-settings-container');
            const addNavItemBtn = document.getElementById('add-nav-item-btn');
            const weatherSettingsContainer = document.getElementById('weather-settings-container');
            const addWeatherCityBtn = document.getElementById('add-weather-city-btn');
            const backgroundSettingsContainer = document.getElementById('background-settings-container');
            const bgUrlInputContainer = document.getElementById('bg-url-input-container');
            const bgUrlInput = document.getElementById('bg-url-input');
            const bgUploadContainer = document.getElementById('bg-upload-container');
            const bgUploadBtn = document.getElementById('bg-upload-btn');
            const bgUploadInput = document.getElementById('bg-upload-input');
            const bgUploadPath = document.getElementById('bg-upload-path');


            let currentConfig = {};

            async function fetchConfigAndRender() {
                console.log("尝试获取配置文件...");
                try {
                    const response = await fetch('/api/config');
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const config = await response.json();
                    console.log("成功获取配置:", config);
                    currentConfig = config;
                    
                    await applyBackground(config.background);
                    renderNavItems(config.navItems || []);
                    renderWeather(config.weather?.cities || []);
                    populateSettingsModal(config);

                } catch (error) {
                    console.error("获取或解析配置文件失败:", error);
                    await applyBackground(); 
                    navContainer.innerHTML = '<div class="text-center p-4 rounded-lg col-span-full">获取导航配置失败。</div>';
                    weatherContent.innerHTML = '<div>获取天气配置失败。</div>';
                }
            }
            
            async function applyBackground(bgConfig) {
                let fallbackUrl = 'https://source.unsplash.com/random/1920x1080?nature,scenery';
                let bgUrl = fallbackUrl;

                if (!bgConfig) {
                    document.body.style.backgroundImage = `url('${bgUrl}')`;
                    return;
                }
                
                try {
                    switch (bgConfig.type) {
                        case 'bing':
                            const response = await fetch('/api/bing-wallpaper');
                            if (!response.ok) throw new Error('从后端获取壁纸失败');
                            const data = await response.json();
                            bgUrl = data.url;
                            break;
                        case 'url':
                            if (bgConfig.value) bgUrl = bgConfig.value;
                            break;
                        case 'upload':
                            if (bgConfig.value) bgUrl = bgConfig.value;
                            break;
                        default:
                            break;
                    }
                } catch (error) {
                    console.error("应用背景失败，将使用备用背景:", error);
                    bgUrl = fallbackUrl;
                }
                
                document.body.style.backgroundImage = `url('${bgUrl}')`;
            }

            function renderNavItems(items) {
                navContainer.innerHTML = '';
                if (!items || items.length === 0) {
                    navContainer.innerHTML = '<div class="text-center p-4 rounded-lg col-span-full">没有配置导航项，请在设置中添加。</div>';
                    return;
                }
                items.forEach(item => {
                    const div = document.createElement('a');
                    div.href = item.url;
                    div.target = "_blank";
                    div.className = "icon-item flex flex-col items-center justify-center p-4 rounded-xl bg-white/10 backdrop-blur-md shadow-lg aspect-square";
                    
                    const iconEl = item.icon && item.icon.startsWith('/uploads/') 
                        ? `<img src="${item.icon}" class="w-12 h-12 mb-2 object-contain" alt="${item.name}">`
                        : `<i data-lucide="${item.icon || 'globe'}" class="w-12 h-12 mb-2"></i>`;

                    div.innerHTML = `${iconEl}<span class="font-semibold text-center text-sm break-all">${item.name}</span>`;
                    navContainer.appendChild(div);
                });
                lucide.createIcons();
            }

            async function updateSystemInfo() {
                try {
                    const response = await fetch('/api/system');
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const data = await response.json();
                    if (!data) throw new Error("No data received from system API");

                    const formatBytes = (bytes, decimals = 2) => {
                        if (!+bytes) return '0 Bytes'
                        const k = 1024;
                        const dm = decimals < 0 ? 0 : decimals;
                        const sizes = ['B', 'KB', 'MB', 'GB', 'TB', 'PB'];
                        const i = Math.floor(Math.log(bytes) / Math.log(k));
                        return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`;
                    };
                    
                    // CPU Info with Fan Speed
                    const cpuTempHtml = data.cpu.temperature ? `
                        <div class="flex justify-between">
                            <span>温度:</span>
                            <span class="font-mono">${data.cpu.temperature}°C</span>
                        </div>` : '';
                    const cpuFanHtml = data.cpu.fanSpeed ? `
                        <div class="flex justify-between">
                            <span>风扇转速:</span>
                            <span class="font-mono">${data.cpu.fanSpeed} RPM</span>
                        </div>` : '';

                    const cpuHtml = `
                        <div>
                            <h4 class="font-bold text-slate-100 mb-1">CPU</h4>
                            <div class="space-y-1 text-xs pl-2">
                                <div class="flex justify-between">
                                    <span>使用率:</span>
                                    <span class="font-mono">${(data.cpu.load || 0).toFixed(2)}%</span>
                                </div>
                                ${cpuTempHtml}
                                ${cpuFanHtml}
                                <div class="flex justify-between">
                                    <span>核心数:</span>
                                    <span class="font-mono">${data.cpu.cores}</span>
                                </div>
                            </div>
                        </div>`;

                    // Memory Info
                    const memHtml = `
                        <div>
                            <h4 class="font-bold text-slate-100 mb-1">内存</h4>
                            <div class="space-y-1 text-xs pl-2">
                                <div class="flex justify-between items-center mb-1">
                                    <span>使用率:</span>
                                    <span class="font-mono">${(data.mem.usage || 0).toFixed(2)}%</span>
                                </div>
                                <div class="w-full bg-slate-700/50 rounded-full h-2.5">
                                    <div class="bg-blue-500 h-2.5 rounded-full" style="width: ${(data.mem.usage || 0).toFixed(2)}%"></div>
                                </div>
                                <div class="text-right text-slate-400 font-mono text-[10px]">${formatBytes(data.mem.used)} / ${formatBytes(data.mem.total)}</div>
                            </div>
                        </div>`;

                    // Network Info
                    const networkHtml = `
                        <div>
                            <h4 class="font-bold text-slate-100 mb-1">网络</h4>
                            <div class="text-xs pl-2 flex flex-col sm:flex-row sm:justify-between sm:items-center">
                                <span class="flex-shrink-0 mb-1 sm:mb-0">速率:</span>
                                <div class="font-mono sm:text-right">
                                    <span class="inline-flex items-center text-green-400">
                                        <i data-lucide="arrow-up" class="w-3 h-3 mr-1"></i>
                                        ${formatBytes((data.net.tx_sec || 0))}/s
                                    </span>
                                    <span class="inline-flex items-center text-cyan-400 ml-2">
                                        <i data-lucide="arrow-down" class="w-3 h-3 mr-1"></i>
                                        ${formatBytes((data.net.rx_sec || 0))}/s
                                    </span>
                                </div>
                            </div>
                        </div>`;

                    // Disk Info
                    const diskRows = (data.fs || []).map(d => `
                        <tr class="border-b border-white/10 last:border-none">
                            <td class="py-1 pr-2 truncate" title="${d.fs}">${d.fs}</td>
                            <td class="py-1 px-2 text-right font-mono whitespace-nowrap text-[11px]">${formatBytes(d.used)}|${formatBytes(d.size)}</td>
                            <td class="py-1 pl-2 text-right font-mono whitespace-nowrap">${(d.use || 0).toFixed(1)}%</td>
                        </tr>
                    `).join('');
                    
                    const diskHtml = `
                        <div>
                            <h4 class="font-bold text-slate-100 mb-1">磁盘</h4>
                            <div class="pl-2 text-xs">
                                <table class="w-full">
                                    <thead>
                                        <tr class="text-left border-b border-white/20">
                                            <th class="py-1 font-semibold">挂载点</th>
                                            <th class="py-1 font-semibold text-right">用量</th>
                                            <th class="py-1 font-semibold text-right">使用率</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${diskRows}
                                    </tbody>
                                </table>
                            </div>
                        </div>`;
                    
                    systemInfoContent.innerHTML = `${cpuHtml}<hr class="border-white/10 my-3">${memHtml}<hr class="border-white/10 my-3">${networkHtml}<hr class="border-white/10 my-3">${diskHtml}`;
                    lucide.createIcons();
                } catch (error) {
                    console.error("更新系统信息失败:", error);
                    systemInfoContent.innerHTML = '<div>获取系统信息失败。</div>';
                }
            }

            async function renderWeather(cities) {
                weatherContent.innerHTML = '';
                if (!cities || cities.length === 0) {
                    weatherContent.innerHTML = '<div>没有配置天气城市。</div>';
                    return;
                }
                try {
                    const results = await Promise.allSettled(cities.map(city => fetch(`/api/weather?city=${encodeURIComponent(city)}`).then(res => res.ok ? res.json() : Promise.reject({city: city, reason: res.statusText}))));
                    
                    let hasSuccess = false;
                    results.forEach((result, index) => {
                        const cityWeatherContainer = document.createElement('div');
                        if (index > 0) {
                            cityWeatherContainer.classList.add('mt-4', 'pt-4', 'border-t', 'border-white/10');
                        }

                        if (result.status === 'fulfilled' && result.value) {
                            hasSuccess = true;
                            const data = result.value;
                            
                            const forecastRows = data.forecast.map(day => `
                                <tr class="border-b border-white/10 last:border-none">
                                    <td class="py-1">${day.date}</td>
                                    <td class="py-1 text-center">
                                        <img src="${day.icon}" class="w-6 h-6 inline-block mx-auto" alt="${day.description}">
                                    </td>
                                    <td class="py-1 text-center">${day.description}</td>
                                    <td class="py-1 text-right font-mono">${day.temp}°</td>
                                </tr>
                            `).join('');
                            
                            if (index === 0) {
                                // 第一个城市，显示完整信息
                                cityWeatherContainer.innerHTML = `
                                    <div class="text-center mb-4">
                                        <h4 class="font-bold text-xl text-slate-50">${data.city}</h4>
                                        <div class="flex items-center justify-center gap-2 mt-1">
                                            <img src="${data.now.icon}" class="w-16 h-16 -ml-4" alt="${data.now.text}">
                                            <span class="text-5xl font-light text-slate-50">${data.now.temp}°</span>
                                        </div>
                                        <p class="text-slate-200 text-sm mt-1">${data.now.text}</p>
                                    </div>
                                    <hr class="border-white/10 my-3">
                                    <div>
                                         <h4 class="font-bold text-slate-100 mb-1">未来预报</h4>
                                         <div class="pl-2 text-xs">
                                             <table class="w-full"><tbody>${forecastRows}</tbody></table>
                                         </div>
                                    </div>`;
                            } else {
                                // 其他城市，显示紧凑信息
                                cityWeatherContainer.innerHTML = `
                                    <div>
                                        <h4 class="font-bold text-lg text-slate-50 mb-2">${data.city}</h4>
                                         <div class="pl-2 text-xs">
                                             <table class="w-full"><tbody>${forecastRows}</tbody></table>
                                         </div>
                                    </div>`;
                            }

                        } else {
                            cityWeatherContainer.innerHTML = `<div><strong>${cities[index]}:</strong> 获取天气失败。</div>`;
                        }
                        weatherContent.appendChild(cityWeatherContainer);
                    });
                    if (!hasSuccess) weatherContent.innerHTML = '<div>所有城市天气信息获取失败。</div>';

                } catch (error) {
                    console.error("加载天气组件时出错:", error);
                    weatherContent.innerHTML = '<div>加载天气组件时出错。</div>';
                }
            }
            
            function populateSettingsModal(config) {
                navSettingsContainer.innerHTML = '';
                (config.navItems || []).forEach((item, index) => addNavItemForm(item, index));
                weatherSettingsContainer.innerHTML = '';
                (config.weather?.cities || []).forEach((city, index) => addWeatherCityForm(city, index));
                const bgConfig = config.background || { type: 'bing', value: '' };
                const radio = backgroundSettingsContainer.querySelector(`input[name="bg-type"][value="${bgConfig.type}"]`);
                if (radio) radio.checked = true;
                bgUrlInput.value = bgConfig.type === 'url' ? bgConfig.value : '';
                bgUploadPath.textContent = bgConfig.type === 'upload' ? bgConfig.value : '';
                updateBgSettingsVisibility();
            }
            
            function addNavItemForm(item = { name: '', url: '', icon: '' }, index = -1) {
                const div = document.createElement('div');
                div.className = 'p-2 bg-white/10 rounded-lg flex items-center gap-2';
                div.innerHTML = `
                    <input type="text" placeholder="名称" value="${item.name}" class="nav-name bg-transparent border-b border-white/30 p-1 flex-grow focus:outline-none focus:border-white placeholder:text-slate-400">
                    <input type="text" placeholder="URL" value="${item.url}" class="nav-url bg-transparent border-b border-white/30 p-1 flex-grow-[2] focus:outline-none focus:border-white placeholder:text-slate-400">
                    <input type="text" placeholder="图标 (Lucide 或路径)" value="${item.icon}" class="nav-icon bg-transparent border-b border-white/30 p-1 flex-grow focus:outline-none focus:border-white placeholder:text-slate-400">
                    <input type="file" class="nav-icon-upload hidden" accept="image/*">
                    <button class="upload-btn p-1 rounded-full hover:bg-white/20" title="上传自定义图标"><i data-lucide="upload"></i></button>
                    <button class="remove-btn p-1 rounded-full hover:bg-white/20 text-red-400" title="删除此项"><i data-lucide="trash-2"></i></button>`;
                navSettingsContainer.appendChild(div);
                lucide.createIcons();
            }

            function addWeatherCityForm(city = '', index = -1) {
                const div = document.createElement('div');
                div.className = 'p-2 bg-white/10 rounded-lg flex items-center gap-2';
                div.innerHTML = `
                    <input type="text" placeholder="城市名称 (例如: 北京)" value="${city}" class="weather-city bg-transparent border-b border-white/30 p-1 flex-grow focus:outline-none focus:border-white placeholder:text-slate-400">
                    <button class="remove-btn p-1 rounded-full hover:bg-white/20 text-red-400" title="删除此城市"><i data-lucide="trash-2"></i></button>`;
                weatherSettingsContainer.appendChild(div);
                lucide.createIcons();
            }

            function updateBgSettingsVisibility() {
                const selectedType = backgroundSettingsContainer.querySelector('input[name="bg-type"]:checked')?.value;
                bgUrlInputContainer.classList.toggle('hidden', selectedType !== 'url');
                bgUploadContainer.classList.toggle('hidden', selectedType !== 'upload');
            }
            
            async function handleSaveSettings() {
                const navItems = Array.from(navSettingsContainer.children).map(div => ({ name: div.querySelector('.nav-name').value, url: div.querySelector('.nav-url').value, icon: div.querySelector('.nav-icon').value }));
                const cities = Array.from(weatherSettingsContainer.children).map(div => div.querySelector('.weather-city').value).filter(city => city.trim() !== '');
                const bgType = backgroundSettingsContainer.querySelector('input[name="bg-type"]:checked')?.value;
                let bgValue = '';
                if (bgType === 'url') bgValue = bgUrlInput.value;
                else if (bgType === 'upload') bgValue = bgUploadPath.textContent;

                const newConfig = { navItems, weather: { cities }, background: { type: bgType, value: bgValue } };

                try {
                    const response = await fetch('/api/config', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(newConfig) });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    alert('设置已保存！页面将重新加载以应用更改。');
                    location.reload();
                } catch (error) {
                    console.error("保存设置失败:", error);
                    alert('保存设置失败，请检查控制台。');
                }
            }

            settingsBtn.addEventListener('click', () => settingsModal.classList.remove('hidden'));
            closeModalBtn.addEventListener('click', () => settingsModal.classList.add('hidden'));
            saveSettingsBtn.addEventListener('click', handleSaveSettings);
            addNavItemBtn.addEventListener('click', () => addNavItemForm());
            addWeatherCityBtn.addEventListener('click', () => addWeatherCityForm());
            bgUploadBtn.addEventListener('click', () => bgUploadInput.click());
            backgroundSettingsContainer.addEventListener('change', updateBgSettingsVisibility);

            settingsModal.addEventListener('click', (e) => {
                if (e.target.closest('.remove-btn')) e.target.closest('.remove-btn').parentElement.remove();
                if (e.target.closest('.upload-btn')) e.target.closest('.upload-btn').previousElementSibling.click();
            });

            settingsModal.addEventListener('change', async (e) => {
                const target = e.target;
                if (target.classList.contains('nav-icon-upload') && target.files[0]) {
                    const formData = new FormData();
                    formData.append('icon', target.files[0]);
                    try {
                        const response = await fetch('/api/upload/icon', { method: 'POST', body: formData });
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        const result = await response.json();
                        target.closest('.flex').querySelector('.nav-icon').value = result.filePath;
                    } catch (error) { alert('图标上传失败！'); }
                }
                if (target.id === 'bg-upload-input' && target.files[0]) {
                    const formData = new FormData();
                    formData.append('background', target.files[0]);
                    try {
                        const response = await fetch('/api/upload/background', { method: 'POST', body: formData });
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        const result = await response.json();
                        bgUploadPath.textContent = result.filePath;
                    } catch (error) { alert('背景上传失败！'); }
                }
            });

            function init() {
                lucide.createIcons();
                fetchConfigAndRender();
                updateSystemInfo();
                setInterval(updateSystemInfo, 5000);
            }

            init();
        });
    </script>
</body>
</html>
